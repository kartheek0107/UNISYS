<!-- canvas.html -->
{% extends 'base.html' %}

{% block title %}Canvas{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="text-center mb-4">Drawing Canvas</h2>
        <div class="text-center">
            <canvas id="drawingCanvas" class="canvas-container" width="800" height="400"></canvas>
            <div class="btn-container">
                <button id="clearBtn" class="btn btn-warning">Clear Canvas</button>
                <button id="submitBtn" class="btn btn-primary">Submit Drawing</button>
            </div>
        </div>

        {% if canvases %}
            <div class="canvas-history">
                <h3>Recent Drawings</h3>
                <div class="row">
                    {% for canvas in canvases %}
                        <div class="col-md-4 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <p class="card-text">Created on: {{ canvas['created_at'].to_native().strftime('%Y-%m-%d %H:%M') if canvas['created_at'] else 'Unknown date' }}</p>
                                    <img src="{{ canvas['image_data'] }}" class="img-fluid" alt="Drawing">
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvas = document.getElementById('drawingCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Set initial canvas state
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = 'black';

        // Drawing functions
        function startDrawing(e) {
            isDrawing = true;
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
            if (!isDrawing) return;
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
            [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // Event listeners for drawing
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch support for mobile devices
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener('touchmove', function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        });

        canvas.addEventListener('touchend', function(e) {
            e.preventDefault();
            const mouseEvent = new MouseEvent('mouseup');
            canvas.dispatchEvent(mouseEvent);
        });

        // Clear button functionality
        document.getElementById('clearBtn').addEventListener('click', function() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'black';
        });

        // Submit button functionality
        document.getElementById('submitBtn').addEventListener('click', function() {
            const imageData = canvas.toDataURL('image/png');

            // Use AJAX to submit the drawing
            fetch('{{ url_for("submit_canvas") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image_data: imageData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    // Reload the page to show the updated history
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while saving the drawing.');
            });
        });
    });
</script>
{% endblock %}
